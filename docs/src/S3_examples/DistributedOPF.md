# Distributed Optimal Power Flow (DC OPF)

This example demonstrates how to solve DC Optimal Power Flow problems in a distributed manner using ADMM with bipartization algorithms.

## Problem Background

### DC Optimal Power Flow

DC Optimal Power Flow (DC OPF) is a fundamental optimization problem in electric power systems. The goal is to find the most cost-effective way to dispatch power generators while satisfying all network constraints under the DC power flow approximation.

Consider a power network $G(N, E)$ where $N$ is the set of buses and $E$ is the set of transmission lines. Let $G_i$ be the set of generators at bus $i$, and $G = \cup_{i\in N}G_i$ be all generators. The DC OPF problem is formulated as:

```math
\begin{aligned}
\min \quad & \sum_{g \in G} c_g(P_g) \\
\text{s.t.} \quad & \sum_{g\in G_i}P_g - P^D_i = \sum_{j: (i,j)\in E} f_{ij}, \quad \forall i \in N \\
& f_{ij} = B_{ij}(\theta_i - \theta_j), \quad \forall (i,j) \in E \\
& \underline{P}_g \leq P_g \leq \overline{P}_g, \quad \forall g \in G \\
& \underline{f}_{ij} \leq f_{ij} \leq \overline{f}_{ij}, \quad \forall (i,j) \in E.
\end{aligned}
```

**Decision Variables:**
- Real power generated by generator $g$: $P_g$
- Voltage angle at bus $i$: $\theta_i$
- Power flow on transmission line $(i,j)$: $f_{ij}$

**Constraints:**
- **Power balance:** Net power injection equals outflow at each bus
- **Power flow equations:** Flow proportional to angle difference (DC approximation)
- **Generation limits:** Generator capacity bounds
- **Transmission limits:** Thermal flow limits on lines


## Distributed Reformulation
The power network is partitioned into $P$ zones $Z_1, \ldots, Z_P$, each controlled by a separate agent. For each zone $p \in [P]$:

- **Zone buses:** $Z_p$ contains buses controlled by agent $p$
- **Boundary buses:** $\text{NB}_p$ contains neighboring buses from other zones
- **Extended zone:** $\overline{Z}_p = Z_p \cup \text{NB}_p$ includes all buses agent $p$ needs to consider
- **Tie lines:** Lines connecting buses in different zones, denoted by $\text{TL}$

In real-world power systems, there's often a need for distributed solutions:
- Power grids span multiple regions controlled by different operators
- Critical system information cannot be shared between regions
- Large-scale problems require distributed computation for efficiency


### Distributed DC OPF Formulation

Each agent $p$ maintains local copies of variables for its extended zone:

$$x_p = \left(\{P_g^p\}_{g\in G_i, i\in Z_p}, \{\theta^{p}_i\}_{i \in \overline{Z}_p}, \{f^p_{ij}\}_{(i,j)\in E\cap(Z_p \times \overline{Z}_p)} \right)$$

**Local Constraint Set:**
$$X_p = \{x_p : \text{local power balance, generation limits, flow equations and limits}\}$$

### Distributed DC OPF Formulation

The original centralized problem is reformulated as:

```math
\begin{aligned}
\min_{\{x_p\}_{p\in [P]}} \quad & \sum_{p=1}^P \left(\sum_{g\in G_i, i\in Z_p} c_g(P_g^p)\right) \\
\text{s.t.} \quad & \theta^{z(i)}_i = \theta^{z(j)}_i, \quad \forall (i,j)\in \text{TL} \\
& \theta^{z(i)}_j = \theta^{z(j)}_j, \quad \forall (i,j)\in \text{TL} \\
& f^{z(i)}_{ij}= f^{z(j)}_{ij}, \quad \forall (i,j)\in \text{TL} \\
& x_p \in X_p, \quad \forall p \in [P]
\end{aligned}
```

Where $z(i)$ denotes the zone containing bus $i$.

**Key Features:**
- **Separable objective:** Generation costs are distributed across zones. They are usually quaradtic or linear with respect to real power generations, and hence are differentiable. 
- **Consensus constraints:** Ensure consistency for tie line variables. These constraints will be relaxed through the augmented Lagrangian function. 
- **Local constraints:** Each zone maintains its own feasible region. We assume the proximal oracle of $X_p$, i.e., projection onto $X_p$ can be computed. This requres minimizing a quadratic function over linear constraints defined by $X_p$. 

### Zone Partitioning
The distributed formulation above is suitable for ADMM **only if** the zone connectivity graph is bipartite. When zones are connected in non-bipartite patterns (containing odd cycles), subproblems corresponding to connected zones are coupled together and hence ADMM are not applicable. 

**Core Idea:** `PDMO.jl` will automatically transform the non-bipartite zone graph into a bipartite form through the following three-step process:

#### 1. Detect
- **Bipartite structure detection:** Automatically detect if the zone connectivity graph is bipartite or contains odd cycles
- **Graph assessment:** Determine if transformation is needed (e.g., if there are only two zones, the graph is already bipartite)

#### 2. Transform using User-Selected Algorithm
- **Algorithm selection:** Apply the user-specified bipartization algorithm to transform the graph into a bipartite structure
- **Edge subdivision:** Break odd cycles by strategically subdividing problematic edges

#### 3. Prepare Necessary Data Structures
- **Introduce auxiliary variables:** Create new consensus variables at subdivision points to maintain problem equivalence
- **Add new consensus constraints:** Establish additional equality constraints linking original and auxiliary variables
- **Update coupling structure:** Ensure all inter-zone couplings follow the bipartite pattern (each constraint couples exactly one "left" variable with one "right" variable)

After this automatic transformation procedure, the OPF problem achieves the desired structure:
- **Bipartite connectivity:** All zones can be assigned to "left" or "right" partitions
- **Simple couplings:** Each consensus constraint involves exactly two zones from different partitions
- **ADMM-ready:** Direct application of ADMM with theoretical convergence guarantees


## Experimental Setup

### Test Cases
We evaluate the above distributed approach on standard IEEE test systems. These data files are available in [Matpower](https://matpower.org). 


### Partitioning Strategy
We use [METIS.jl](https://github.com/JuliaSparse/Metis.jl) to divide each network into 3-10 zones, where each zone represents a separate control area. 
As the partitions given by `METIS.jl` are in general not bipartitie, we further compare two bipartization algorithms: 
- **MILP Bipartization:** Use mixed-integer programming to minimize cetrain metric related to the worst case iteration complexity. 
- **BFS Bipartization:** Heuristic using breadth-first search to break odd cycles. 

### ADMM Parameters

```julia
param = ADMMParam()
param.solver = AdaptiveLinearizedSolver(gamma=1.0, r=1e5)
param.maxIter = 500000
param.timeLimit = 7200      # time limit in seconds
param.presTolL2 = Inf 
param.dresTolL2 = Inf 
param.presTolLInf = 1e-3    # report optimal if max primal/dual
param.dresTolLInf = 1e-3    # residuals are less than 1e-3
```

### Results 

The experimental results demonstrate the effectiveness of the bipartization approach across different IEEE test systems. Below we present detailed performance comparisons between MILP and BFS bipartization algorithms for each test case.

#### Case 30 (30-bus system)
**Performance Summary:**

| Partitions | MILP Iters | MILP Time (s) | MILP Abs Diff | BFS Iters | BFS Time (s) | BFS Abs Diff |
|------------|-------------|---------------|---------------|-----------|--------------|--------------|
| 3          | 696         | 4.75          | 6.00e-04      | 696       | 2.77         | 6.00e-04     |
| 4          | 1462        | 6.05          | 2.39e-02      | 4421      | 17.81        | 1.88e-02     |
| 5          | 565         | 2.24          | 1.00e-02      | 804       | 3.11         | 1.60e-03     |
| 6          | 680         | 2.97          | 1.61e-02      | 680       | 2.65         | 1.61e-02     |
| 7          | 720         | 3.32          | 7.10e-03      | 612       | 2.65         | 8.20e-03     |
| 8          | 733         | 3.34          | 4.50e-03      | 792       | 3.61         | 1.70e-03     |
| 9          | 2598        | 11.96         | 1.13e-02      | 1560      | 6.60         | 1.36e-02     |
| 10         | 2586        | 13.28         | 1.36e-02      | 1614      | 6.97         | 1.00e-04     |
| **Average**| **1255**    | **5.99**      | **1.09e-02**  | **1397**  | **5.77**     | **7.60e-03** |

**Overall Statistics:**
- MILP: Average 1255.0 iterations, 5.99s, 8/8 convergence
- BFS: Average 1397.4 iterations, 5.77s, 8/8 convergence

#### Case 57 (57-bus system)
**Performance Summary:**

| Partitions | MILP Iters | MILP Time (s) | MILP Abs Diff | BFS Iters | BFS Time (s) | BFS Abs Diff |
|------------|-------------|---------------|---------------|-----------|--------------|--------------|
| 3          | 4717        | 21.83         | 0.00e+00      | 4722      | 19.29        | 0.00e+00     |
| 4          | 3369        | 14.07         | 2.20e-01      | 5530      | 21.78        | 6.00e-02     |
| 5          | 7685        | 31.38         | 0.00e+00      | 9168      | 38.21        | 1.80e-01     |
| 6          | 12651       | 51.16         | 4.00e-02      | 9907      | 40.31        | 1.80e-01     |
| 7          | 9119        | 36.91         | 7.30e-01      | 11176     | 45.76        | 2.70e-01     |
| 8          | 7012        | 30.59         | 2.00e-01      | 11661     | 54.55        | 1.00e-01     |
| 9          | 12450       | 72.65         | 2.80e-01      | 20922     | 141.91       | 3.70e-01     |
| 10         | 30712       | 197.54        | 9.00e-02      | 43959     | 282.54       | 2.00e-02     |
| **Average**| **10964**   | **57.02**     | **1.95e-01**  | **14631** | **80.54**    | **1.48e-01** |

**Overall Statistics:**
- MILP: Average 10964.4 iterations, 57.02s, 8/8 convergence
- BFS: Average 14630.6 iterations, 80.54s, 8/8 convergence

#### Case 89pegase (89-bus system)
**Performance Summary:**

| Partitions | MILP Iters | MILP Time (s) | MILP Abs Diff | BFS Iters | BFS Time (s) | BFS Abs Diff |
|------------|-------------|---------------|---------------|-----------|--------------|--------------|
| 3          | 100740      | 818.72        | 0.00e+00      | 58182     | 493.29       | 0.00e+00     |
| 4          | 70619       | 573.48        | 0.00e+00      | 70619     | 556.25       | 0.00e+00     |
| 5          | 152987      | 1169.31       | 1.00e-02      | 127198    | 797.80       | 1.00e-02     |
| 6          | 347983      | 2166.73       | 1.00e-02      | 212998    | 1302.99      | 1.00e-02     |
| 7          | 172778      | 1107.11       | 0.00e+00      | 118400    | 719.54       | 0.00e+00     |
| 8          | 399074      | 2945.31       | 0.00e+00      | 500000*   | 3776.84      | 0.00e+00     |
| 9          | 424753      | 3306.33       | 0.00e+00      | 416630    | 2763.47      | 0.00e+00     |
| 10         | 500000*     | 3508.14       | 0.00e+00      | 500000*   | 3893.15      | 0.00e+00     |
| **Average**| **271117**  | **1949.39**   | **2.50e-03**  | **250503** | **1787.92**  | **2.50e-03** |

*Hit iteration limit

**Overall Statistics:**
- MILP: Average 271116.8 iterations, 1949.39s, 7/8 convergence
- BFS: Average 250503.4 iterations, 1787.92s, 6/8 convergence

#### Case 118 (118-bus system)

| Partitions | MILP Iters | MILP Time (s) | MILP Abs Diff | BFS Iters | BFS Time (s) | BFS Abs Diff |
|------------|-------------|---------------|---------------|-----------|--------------|--------------|
| 3          | 500000*     | 3328.25       | 6.00e-02      | 500000*   | 3134.82      | 6.00e-02     |
| 4          | 196674      | 1192.41       | 0.00e+00      | 219267    | 1357.12      | 2.00e-02     |
| 5          | 157265      | 913.78        | 1.00e-02      | 421100    | 2538.47      | 5.00e-02     |
| 6          | 469894      | 2861.42       | 1.00e-02      | 310285    | 1878.80      | 1.00e-02     |
| 7          | 500000*     | 3134.15       | 7.00e-02      | 500000*   | 3916.00      | 1.00e-01     |
| 8          | 327146      | 2056.68       | 0.00e+00      | 273241    | 2532.66      | 1.00e-02     |
| 9          | 500000*     | 3287.07       | 4.00e-02      | 500000*   | 3298.54      | 2.60e-01     |
| 10         | 247418      | 1609.12       | 0.00e+00      | 500000*   | 4097.89      | 3.00e-02     |
| **Average**| **362300**  | **2297.86**   | **2.38e-02**  | **402987** | **2844.29**  | **6.75e-02** |

*Hit iteration limit

**Overall Statistics:**
- MILP: Average 362299.6 iterations, 2297.86s, 5/8 convergence
- BFS: Average 402986.6 iterations, 2844.29s, 4/8 convergence

#### Case 300 (300-bus system)

| Partitions | MILP Iters | MILP Time (s) | MILP Abs Diff | BFS Iters | BFS Time (s) | BFS Abs Diff |
|------------|-------------|---------------|---------------|-----------|--------------|--------------|
| 3          | 500000*     | 6595.10       | 2.00e-02      | 500000*   | 5745.13      | 3.00e-02     |
| 4          | 44125       | 451.56        | 4.00e-02      | 46336     | 470.23       | 1.00e-02     |
| 5          | 63456       | 613.71        | 1.00e-02      | 62758     | 605.65       | 1.00e-02     |
| 6          | 141267      | 1262.08       | 1.00e-02      | 256760    | 2301.45      | 1.00e-02     |
| 7          | 88318       | 755.26        | 1.00e-02      | 86520     | 736.64       | 2.00e-02     |
| 8          | 320560      | 2671.08       | 1.00e-02      | 441353    | 4476.19      | 2.00e-02     |
| 9          | 78130       | 674.80        | 1.00e-02      | 75884     | 636.14       | 3.00e-02     |  
| 10         | 333189      | 2867.36       | 0.00e+00      | 317086    | 2589.16      | 1.00e-02     |
| **Average**| **196131**  | **1986.37**   | **1.38e-02**  | **223337** | **2195.08**  | **1.75e-02** |

*Hit iteration limit

**Overall Statistics:**
- MILP: Average 196130.6 iterations, 1986.37s, 7/8 convergence 
- BFS: Average 223337.1 iterations, 2195.08s, 7/8 convergence

#### Case 1888rte (1888-bus system)


| Partitions | MILP Iters | MILP Time (s) | MILP Abs Diff | BFS Iters | BFS Time (s) | BFS Abs Diff |
|------------|-------------|---------------|---------------|-----------|--------------|--------------|
| 3          | 101368      | 5511.77       | 0.00e+00      | 101368    | 5610.75      | 0.00e+00     |
| 4          | 148390      | 6423.14       | 0.00e+00      | 135895    | 5857.55      | 0.00e+00     |
| 5          | 196675      | 6945.33       | 0.00e+00      | 193456    | 7200.01*     | 1.00e-02     |
| 6          | 228659      | 6742.48       | 0.00e+00      | 228659    | 6839.82      | 0.00e+00     |
| 7          | 243140      | 7200.00*      | 0.00e+00      | 237310    | 7070.78      | 0.00e+00     |
| 8          | 247383      | 7029.14       | 0.00e+00      | 212039    | 5732.35      | 0.00e+00     |
| 9          | 231385      | 6112.67       | 0.00e+00      | 226505    | 5970.93      | 0.00e+00     |
| 10         | 164693      | 4072.68       | 0.00e+00      | 216148    | 7200.01*     | 0.00e+00     |
| **Average**| **195212**  | **6254.65**   | **0.00e+00** | **193923** | **6435.27**  | **1.25e-03** |

*Hit time limit


**Note**: The experiments presented here are primarily intended to demonstrate the correctness of bipartization algorithms and illustrate how different reformulations affect ADMM convergence behavior. The distributed approach is not currently designed to compete with centralized solvers in terms of computational efficiency. We will focus on performance optimization and scalability improvements in future development.

